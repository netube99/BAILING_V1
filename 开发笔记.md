# BAILING 开发笔记

## USB供电处理

1. 因为BAILING只用数据线进行数据收发与供电，所以能够从电脑USB口获得的电源应该噪声纹波都不小，需要做一些比较激进的滤波设计；
2. VBUS先经过500mA自恢复保险丝做限流，经过两个小滤波电容和正负极各一个磁珠；
3. 给200uF的大钽电容充电蓄能；并且在钽电容的负极用两颗磁珠分隔数字和模拟地，两个地最终在滤波电容的负极实现单点接地，尽可能的避免耦合干扰；电源分配到后面的芯片还会再做进一步的滤波降噪处理；

## CM108B

为了权衡录音与回放的质量，CM108B应该是我能买到的内置ADC指标较高较符合需求的Codec芯片，CM108AH的DAC性能更好，但是ADC指标相比之下要低很多，CH108B的ADC THD+N和动态范围都要比AH高，TI的PCM2902A也不错，但是没有线路输出也没有I2S输出；CM108B的DAC质量差点没关系，利用I2S输出外接其他专业音频DAC就好了，主要是保证麦克风ADC的性能；

1. 回放和记录仅支持16bit 48K/44.1K Hz采样率，播放更高采样或深度的文件（有待测试）；
2. 麦克风输入增益默认+12dB，+22dB需要外加SPI EEPROM设置，我不使用，不知道电脑驱动端能不能直接设置麦克风硬件增益等级到+22dB？；
3. 数字输出是I2S格式，非左对齐格式；
4. 内置12M晶振和PLL，需要测量48K/44.1K Hz下播放时MCLK的时钟精度 (fixed at x256)，理论上44.1K采样时MCLK应为11.2896MHz，48K采样时应该为12.288MHz；
5. 有HID可调电脑音量和静音，VOLUP VOLDN MUTER MUTEP，不使用，因为内置上拉，选择浮空，如果使用的话接个按键直接接地就行，电平跳变触发；
6. 5V电源供电，内置3.6V/3.3V/1.8V稳压和VREF，其中3.6V为模拟电路供电，在稳压输出端应该加滤波电容并不要接任何负载，仅供芯片内部调用；3.3V输出端加10uF/104电容，给外部数字芯片供电，注意电流40mA限制；1.8V输出给内部的数字核心电路供电，应该和3.6V一样处理，加电容并且不要加任何外部负载；VREF硬件为内置参考电压源输出，和DAC/ADC有密切关系，应该外界滤波电容并不连接任何负载
7. PDSW用来下拉控制外部功率PMOS开关，不使用，浮空处理；
8. 因为内置DAC的指标不好看，不直接使用内置线性输出，使用I2S外接高性能DAC；
9. MODE、PWRSEL引脚接地，将芯片设置为耳机模式：回放和录制、500mA总线供电；
10. ADSEL接地，使用内置麦克风ADC（接高电平设置为麦克风数据I2S输入，我不使用外部ADC）；
11. TEST接地，为正常工作模式；
12. MSEL接地，翻译为混合器有点奇怪，不知道是不是芯片内部的麦克风信号耦合到线路输出的意思，还是和音效有关的设置？接地为disabled，不用这玩意；
13. GPIO、LED用不上，浮空；
14. LOBS为直流1.75V输出偏置，虽然不用线性输出但为了稳定性考虑还是接个1uF左右的电容；
15. 麦克风的偏置电压需要加一个RC滤波和一个1.2K的限流电阻，并且需要通过1uF的电容耦合到MIC输入端；
16. SPDIFO不用，浮空处理；
17. USB D+线需要上拉1.5K电阻到DREG33上，当芯片的稳压系统正常工作后，起到一个给D+上拉的作用，触发主机端对USB设备的枚举；
18. 因为不清楚USB的供电质量，所以加的滤波电容比较夸张，内置LDO的输出滤波电容不适合用太大的，以免上电时电流过大，损坏芯片，VBUS端的电容可以大一些；
19. 注意芯片的数字地引脚和模拟地引脚，需要连接到各自的地平面，最终在电源滤波电容负极单点接地；
20. 注意耳机插座的引脚定义，我使用CTIA标准，从尖端数起是左右地麦；

## SN74LVC245A

因为CM108B为5V供电，数据线的逻辑电压为高电平5V，所以为了外接的DAC芯片的耐压考虑，我加了个SN74LVC245A作为IO缓冲，起到5V电平转3.3V的作用，要注意测量延时问题，必须满足MCLK的频率，供电从CM108B 的 DREG33获取3.3V；

1. A1到A4四个引脚作为输入连接CM108的I2S输出，对应的B1到B4作为输出连接到ES9023 DAC的I2S输入引脚；
2. DIR连接到电源3.3V高电平，设置传输反向为A输入B输出；
3. OE接地，使能芯片；

## ES9023

独立的音频DAC芯片，用于弥补CM108较差的DAC性能；

1. ES9023虽然支持24bit 192k的PCM解码能力，但是受限于USB接口芯片CM108B的限制，只能使用16bit 44.1K/48K格式；
2. 注意I2S引脚的输入格式，DIF拉低为I2S格式，上拉为左对齐格式，使用标准I2S格式，DIF拉低；
3. 似乎不分模拟电源和数字电源，给AVCC提供3.6V的电源电压，可以获取2Vrms的线性输出电平等级；
4. ZD似乎是个无音频数据的空闲中断引脚，浮空不使用；
5. MUTE_B是下拉静音，根据官方的参考电路在这里接了个RC电路，RC的输入端是电源，似乎是起到了一个缓启动的功能，上电瞬间MUTE是拉低的，电容开始缓慢充电，待芯片稳定工作后电容电压才缓慢达到使能线性输出的电压，可能是为了防止上电爆破声损坏耳机；
6. CP/CN脚的电容尽可能靠近芯片导线尽可能短，避免电荷泵电路开关信号会干扰其他电路；
7. NEG是负电源的输出，接滤波电容，尽可能靠近管脚放置；
8. VREG是参考电压源的输出，需要接一个10uF的滤波电容到地，同时需要根据电源电压接一个100K以上的电阻到地，似乎是和内部的分压电阻有关，似乎决定了线性输出的电压幅值？
9. 因为ES9023需要3.6V电源电压，使用低噪声高PSRR高速稳压器RT9193将5V降低到3.6V；
10. 因为不想使用过多的耦合电容和电源电路，节省PCB布局空间，我不采用运放电路设计线性输出的低通滤波电路，只使用二阶RC低通滤波，滤波电路的仿真数据也有提供；
11. 电荷泵电容按照官方参考选择1uF即可，不宜使用过大电容，因为电荷泵开关频率固定，电容充电需要一定的时间，超过范围会导致电路工作不稳定；

## TPA6133A2

1. 由于前级DAC是Vrms单端输出，所以根据数据手册要求，使用0.47uF电容耦合，单端信号输入耦合到LEFTINM 和RIGHTINM，因为耦合电容和芯片内部的输入电阻形成一个高通滤波器，所以不可盲目选择大电容，因为是信号耦合不是功率驱动的耦合，没必要用大电容；
2. 因为需要给耳机提供驱动功率，所以VDD模拟电源我用了两个10uF钽电容、一颗104并联；
3. SD脚上拉到电源，使能电荷泵和放大电路，内置缓启动；
4. TEST1、2脚通过电阻上拉自电源，正常运行模式；
5. CPP/CPN/CPVSS接电容的方法和ES9023差不多，尽可能靠近芯片管脚；
6. 耳机驱动输出不需要耦合电容，直接连接耳机；
7. 电荷泵的电容容量按照官方参考选择1uF左右，不宜过大；

## 焊接后调试记录

1. 高通滤波后需要加电位器衰减信号；
2. 耳放芯片输出预留电阻焊盘，用于增加功率电阻，降低噪音和阻抗匹配；
3. CM108B的LOBS硬件可以浮空，接电容后测量到一个正弦波并对周围电路有干扰；
4. USB Vbus的滤波可以设计得更激进；